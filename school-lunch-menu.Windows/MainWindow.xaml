<Window x:Class="SchoolLunchMenu.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SchoolLunchMenu.ViewModels"
        mc:Ignorable="d"
        Title="School Lunch Menu"
        Icon="Assets/logo.ico"
        Height="800" Width="1100"
        MinHeight="500" MinWidth="850"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        AllowDrop="True"
        DragOver="OnDragOver"
        Drop="OnDrop"
        d:DataContext="{d:DesignInstance vm:MainViewModel}">

    <Window.InputBindings>
        <KeyBinding Key="Escape" Command="{x:Static ApplicationCommands.Close}" />
    </Window.InputBindings>

    <Window.CommandBindings>
        <CommandBinding Command="{x:Static ApplicationCommands.Close}" Executed="OnClose" />
    </Window.CommandBindings>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_Help">
                <MenuItem Header="_About School Lunch Menu" Click="OnAboutClick" />
            </MenuItem>
        </Menu>

        <Grid Margin="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Left sidebar: Settings panel -->
        <Border Grid.Column="0" BorderBrush="#DEE2E6" BorderThickness="1" CornerRadius="4" Padding="10" Margin="0,0,8,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,6,0">
                <StackPanel Margin="0,0,4,0">
                    <!-- School Lookup section -->
                    <TextBlock Text="School Lookup" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />

                    <TextBlock Text="Identifier Code" FontSize="11" Foreground="#6c757d" Margin="0,0,0,2" />
                    <Grid Margin="0,0,0,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0"
                                 Text="{Binding IdentifierCode, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="Enter the family menu identifier code (e.g., YVAM38)"
                                 Margin="0,0,4,0" />
                        <Button Grid.Column="1"
                                Content="Look Up"
                                Command="{Binding LookupIdentifierCommand}"
                                ToolTip="Look up district and buildings for this identifier"
                                Padding="8,4" />
                    </Grid>

                    <TextBlock Text="{Binding DistrictName}"
                               FontSize="11" Foreground="#6c757d"
                               TextWrapping="Wrap"
                               Visibility="{Binding DistrictName, Converter={StaticResource NullToCollapsedConverter}, FallbackValue=Collapsed}"
                               Margin="0,0,0,4" />

                    <StackPanel Visibility="{Binding HasBuildings, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <TextBlock Text="Building" FontSize="11" Foreground="#6c757d" Margin="0,0,0,2" />
                        <ComboBox ItemsSource="{Binding AvailableBuildings}"
                                  SelectedItem="{Binding SelectedBuilding}"
                                  DisplayMemberPath="Name"
                                  ToolTip="Select the school building"
                                  Margin="0,0,0,4" />
                    </StackPanel>

                    <Separator Margin="0,4,0,10" />

                    <!-- Month/Year selection -->
                    <TextBlock Text="Month &amp; Year" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />

                    <ComboBox x:Name="MonthCombo"
                              TabIndex="0"
                              ItemsSource="{Binding AvailableMonths}"
                              SelectedValue="{Binding SelectedMonth}"
                              SelectedValuePath="Number"
                              DisplayMemberPath="Name"
                              ToolTip="Select the month to display"
                              Margin="0,0,0,4" />

                    <ComboBox TabIndex="1"
                              ItemsSource="{Binding AvailableYears}"
                              SelectedItem="{Binding SelectedYear}"
                              ToolTip="Select the year to display"
                              Margin="0,0,0,10" />

                    <!-- Serving Session -->
                    <StackPanel Visibility="{Binding HasSessions, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <TextBlock Text="Serving Session" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                        <ComboBox ItemsSource="{Binding AvailableSessions}"
                                  SelectedItem="{Binding SelectedSession}"
                                  ToolTip="Select the serving session (e.g., Lunch, Breakfast)"
                                  Margin="0,0,0,10" />
                    </StackPanel>

                    <Separator Margin="0,0,0,10" />

                    <!-- Calendar Theme -->
                    <TextBlock Text="Calendar Theme" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                    <ComboBox ItemsSource="{Binding ThemeListItems}"
                              SelectedItem="{Binding SelectedThemeItem}"
                              ToolTip="Select a visual theme for the generated calendar"
                              Margin="0,0,0,10">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding DisplayText}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHeader}" Value="True">
                                                    <Setter Property="FontWeight" Value="Bold" />
                                                    <Setter Property="Foreground" Value="#6c757d" />
                                                    <Setter Property="FontSize" Value="11" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <ComboBox.ItemContainerStyle>
                            <Style TargetType="ComboBoxItem">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsHeader}" Value="True">
                                        <Setter Property="IsEnabled" Value="False" />
                                        <Setter Property="IsHitTestVisible" Value="False" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ComboBox.ItemContainerStyle>
                    </ComboBox>

                    <Separator Margin="0,0,0,10" />

                    <!-- Allergen selection (collapsible) -->
                    <Expander IsExpanded="{Binding IsAllergenExpanded}" Margin="0,0,0,4">
                        <Expander.Header>
                            <TextBlock Text="Allergen Filter" FontWeight="Bold" FontSize="13" />
                        </Expander.Header>
                        <StackPanel Margin="0,6,0,0">
                            <TextBlock Text="Items containing selected allergens will be shown in strikethrough."
                                       TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />
                            <ItemsControl ItemsSource="{Binding AvailableAllergens}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding Name}"
                                                  IsChecked="{Binding IsSelected}"
                                                  Margin="0,2"
                                                  ToolTip="{Binding Name, StringFormat='Filter out items containing {0}'}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Expander>
                    <TextBlock Text="{Binding AllergenSummary}"
                               FontSize="11" Foreground="#6c757d"
                               TextWrapping="Wrap"
                               Margin="0,0,0,10" />

                    <Separator Margin="0,0,0,10" />

                    <!-- Not Preferred Foods -->
                    <StackPanel Visibility="{Binding HasRecipes, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <TextBlock Text="Not Preferred Foods" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                        <TextBlock Text="Checked items are allergen-free but won't count as safe options. Type to search."
                                   TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />

                        <TextBox Text="{Binding RecipeSearchText, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="Search not-preferred foods by name"
                                 Margin="0,0,0,4" />

                        <ItemsControl ItemsSource="{Binding FilteredRecipes}" Margin="0,0,0,10">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Name}"
                                              IsChecked="{Binding IsNotPreferred}"
                                              Margin="0,2"
                                              ToolTip="{Binding Name, StringFormat='Mark {0} as not preferred'}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Separator Margin="0,0,0,10" />
                    </StackPanel>

                    <!-- Favorite Foods -->
                    <StackPanel Visibility="{Binding HasRecipes, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <TextBlock Text="Favorite Foods" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                        <TextBlock Text="Starred items get highlighted on the calendar. Type to search."
                                   TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />

                        <TextBox Text="{Binding FavoriteSearchText, UpdateSourceTrigger=PropertyChanged}"
                                 ToolTip="Search favorite foods by name"
                                 Margin="0,0,0,4" />

                        <ItemsControl ItemsSource="{Binding FilteredFavorites}" Margin="0,0,0,10">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsFavorite}" Margin="0,2"
                                              ToolTip="{Binding Name, StringFormat='Mark {0} as a favorite'}">
                                        <CheckBox.Content>
                                            <TextBlock Text="{Binding Name}" />
                                        </CheckBox.Content>
                                    </CheckBox>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Separator Margin="0,0,0,10" />
                    </StackPanel>

                    <!-- From Home Days -->
                    <StackPanel Visibility="{Binding HasSessions, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <TextBlock Text="From Home Days" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                        <TextBlock Text="Force ðŸ  From Home badge on selected weekdays."
                                   TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />
                        <ItemsControl ItemsSource="{Binding ForcedHomeDays}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding DisplayName}"
                                              IsChecked="{Binding IsForced}"
                                              Margin="0,2"
                                              ToolTip="{Binding DisplayName, StringFormat='Force From Home badge on {0}s'}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <Separator Margin="0,0,0,10" />

                    <!-- Holiday Overrides (collapsible) -->
                    <Expander Margin="0,0,0,4">
                        <Expander.Header>
                            <TextBlock Text="Holiday Icons" FontWeight="Bold" FontSize="13" />
                        </Expander.Header>
                        <StackPanel Margin="0,6,0,0">
                            <TextBlock Text="Customize emoji and messages for no-school days by keyword."
                                       TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />
                            <ItemsControl ItemsSource="{Binding HolidayOverrideEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="30" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBox Grid.Column="0"
                                                     Text="{Binding Keyword, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Keyword to match in academic note (e.g., thanksgiving)"
                                                     FontSize="11" Padding="2" />
                                            <TextBox Grid.Column="1"
                                                     Text="{Binding Emoji, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Emoji to display"
                                                     FontSize="11" Padding="2" Margin="2,0" />
                                            <Button Grid.Column="2" Content="âœ•" Padding="4,0"
                                                    FontSize="10"
                                                    Command="{Binding DataContext.RemoveHolidayOverrideCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Remove this override" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Button Content="+ Add Override"
                                    Command="{Binding AddHolidayOverrideCommand}"
                                    Padding="8,4" Margin="0,4,0,0"
                                    FontSize="11" />
                        </StackPanel>
                    </Expander>

                    <Separator Margin="0,0,0,10" />

                    <!-- Day Layout Mode -->
                    <TextBlock Text="Day Layout" FontWeight="Bold" FontSize="13" Margin="0,0,0,6" />
                    <ComboBox ItemsSource="{x:Static vm:MainViewModel.LayoutModeOptions}"
                              SelectedValue="{Binding SelectedLayoutMode}"
                              SelectedValuePath="Value"
                              DisplayMemberPath="DisplayText"
                              ToolTip="Choose how day cells are laid out: List (badges + items), or grid with icon buttons"
                              Margin="0,0,0,4" />

                    <!-- Show unsafe lines (visible when grid mode active) -->
                    <CheckBox Content="Show unsafe lines"
                              IsChecked="{Binding ShowUnsafeLines}"
                              ToolTip="Show grayed-out buttons for plan lines with no allergen-safe options"
                              Margin="12,0,0,4"
                              Visibility="{Binding IsGridMode, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}" />
                    <TextBox Text="{Binding UnsafeLineMessage, UpdateSourceTrigger=PropertyChanged}"
                             FontSize="11" Padding="2"
                             Margin="24,0,0,4"
                             ToolTip="Custom message shown next to grayed-out buttons"
                             Visibility="{Binding ShowUnsafeLines, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}" />

                    <!-- Plan config (visible when grid mode active and plans loaded) -->
                    <ItemsControl ItemsSource="{Binding PlanLabelEntries}"
                                  Margin="12,0,0,10"
                                  Visibility="{Binding IsGridMode, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="46" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <!-- Reorder buttons -->
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,2,0">
                                        <Button Content="â–²" Padding="2,0" FontSize="8"
                                                Command="{Binding DataContext.MovePlanUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Move up" />
                                        <Button Content="â–¼" Padding="2,0" FontSize="8"
                                                Command="{Binding DataContext.MovePlanDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Move down" />
                                    </StackPanel>
                                    <!-- Emoji icon (editable dropdown) -->
                                    <ComboBox Grid.Column="1"
                                              IsEditable="True"
                                              Text="{Binding Icon, UpdateSourceTrigger=LostFocus}"
                                              ItemsSource="{Binding DataContext.PlanIconSuggestions, RelativeSource={RelativeSource AncestorType=Window}}"
                                              FontSize="11" Padding="2" Margin="0,0,2,0"
                                              ToolTip="Emoji icon for this plan â€” pick from list or type your own" />
                                    <!-- View mode: display label + edit button -->
                                    <Grid Grid.Column="2"
                                          Visibility="{Binding IsEditing, Converter={StaticResource BoolToCollapsedConverter}, FallbackValue=Visible}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding DisplayLabel}"
                                                   FontSize="10"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   ToolTip="{Binding PlanName}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#6c757d" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasCustomLabel}" Value="True">
                                                            <Setter Property="Foreground" Value="#333" />
                                                            <Setter Property="FontWeight" Value="SemiBold" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <Button Grid.Column="1" Content="âœï¸" Padding="2,0" FontSize="9"
                                                Margin="2,0,0,0"
                                                Command="{Binding DataContext.EditPlanLabelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Edit short label" />
                                    </Grid>
                                    <!-- Edit mode: TextBox + reset + done -->
                                    <Grid Grid.Column="2"
                                          Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibleConverter}, FallbackValue=Collapsed}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0"
                                                 Text="{Binding ShortLabel, UpdateSourceTrigger=PropertyChanged}"
                                                 FontSize="11" Padding="2"
                                                 IsVisibleChanged="OnPlanLabelTextBoxVisibleChanged"
                                                 KeyDown="OnPlanLabelTextBoxKeyDown"
                                                 ToolTip="{Binding PlanName, StringFormat='Editing label for: {0}'}" />
                                        <Button Grid.Column="1" Content="â†©" Padding="3,0" FontSize="10"
                                                Margin="2,0,0,0"
                                                Command="{Binding DataContext.ResetPlanLabelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Reset to original name" />
                                        <Button Grid.Column="2" Content="âœ“" Padding="3,0" FontSize="10"
                                                Margin="2,0,0,0"
                                                Command="{Binding DataContext.EditPlanLabelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="Done editing" />
                                    </Grid>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <CheckBox Content="Cross out past days"
                              IsChecked="{Binding CrossOutPastDays}"
                              ToolTip="Fade and mark past days with an X on the calendar"
                              Margin="0,4,0,4" />

                    <CheckBox Content="Share link on calendar"
                              IsChecked="{Binding ShowShareFooter}"
                              ToolTip="Add a QR code and link to the project GitHub page at the bottom of the calendar"
                              Margin="0,4,0,4" />

                    <Separator Margin="0,0,0,10" />

                    <!-- Day Labels (Red/White Day) -->
                    <Expander Margin="0,0,0,4">
                        <Expander.Header>
                            <TextBlock Text="Day Labels (Red/White Day)" FontWeight="Bold" FontSize="13" />
                        </Expander.Header>
                        <StackPanel Margin="0,6,0,0">
                            <TextBlock Text="Labels rotate across school days in order. No-school days are skipped."
                                       TextWrapping="Wrap" FontSize="11" Foreground="#6c757d" Margin="0,0,0,6" />
                            <Button Content="Fetch from CMS"
                                    Command="{Binding FetchDayLabelsCommand}"
                                    ToolTip="Fetch Red/White Day schedule from the ISD194 school calendar"
                                    Padding="8,4" Margin="0,0,0,6"
                                    FontSize="11" />
                            <TextBlock Text="Corner" FontSize="11" Margin="0,4,0,2" />
                            <ComboBox ItemsSource="{x:Static vm:MainViewModel.DayLabelCornerOptions}"
                                      SelectedItem="{Binding DayLabelCorner}"
                                      FontSize="11"
                                      ToolTip="Which corner the label triangle appears in"
                                      Margin="0,0,0,4" />
                            <TextBlock Text="Start Date" FontSize="11" Margin="0,4,0,2" />
                            <TextBox Text="{Binding DayLabelStartDate, UpdateSourceTrigger=PropertyChanged}"
                                     FontSize="11"
                                     ToolTip="Anchor date (M/d/yyyy). Blank = first school day of month."
                                     Margin="0,0,0,6" />
                            <ItemsControl ItemsSource="{Binding DayLabelEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="70" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBox Grid.Column="0"
                                                     Text="{Binding Label, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Label text (e.g., Red, White, A, B)"
                                                     FontSize="11" Padding="2" />
                                            <ComboBox Grid.Column="1"
                                                      IsEditable="True"
                                                      Text="{Binding Color, UpdateSourceTrigger=LostFocus}"
                                                      ItemsSource="{Binding DataContext.DayLabelColorSuggestions, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      FontSize="11" Padding="2" Margin="2,0"
                                                      ToolTip="CSS color for the corner triangle (e.g., #dc3545)" />
                                            <Button Grid.Column="2" Content="âœ•" Padding="4,0"
                                                    FontSize="10"
                                                    Command="{Binding DataContext.RemoveDayLabelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Remove this label" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Button Content="+ Add Label"
                                    Command="{Binding AddDayLabelCommand}"
                                    Padding="8,4" Margin="0,4,0,0"
                                    FontSize="11" />
                        </StackPanel>
                    </Expander>

                    <Separator Margin="0,0,0,10" />

                    <!-- Action buttons -->
                    <Button TabIndex="4"
                            Content="_Fetch from API"
                            Command="{Binding FetchFromApiCommand}"
                            IsDefault="True"
                            ToolTip="Fetch menu data from the LINQ Connect API (Enter)"
                            Padding="8,6" Margin="0,0,0,6" />

                    <Button TabIndex="5"
                            Content="_Load from HAR"
                            Command="{Binding LoadFromHarCommand}"
                            ToolTip="Load menu data from a saved HAR file for offline use"
                            Padding="8,6" Margin="0,0,0,6" />

                    <Button TabIndex="6"
                            Content="_Generate Calendar"
                            Command="{Binding GenerateCalendarCommand}"
                            ToolTip="Generate and open the printable HTML calendar"
                            Padding="8,6"
                            FontWeight="Bold"
                            Background="#28a745"
                            Foreground="White" />

                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Right side: Preview and status -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- WebBrowser preview -->
            <Border Grid.Row="0" BorderBrush="#DEE2E6" BorderThickness="1" CornerRadius="4">
                <Grid>
                    <TextBlock Text="Calendar preview will appear here after generation."
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Foreground="#ADB5BD"
                               FontSize="14"
                               Visibility="{Binding GeneratedHtml, Converter={StaticResource NullToVisibleConverter}, FallbackValue=Visible}" />
                    <WebBrowser x:Name="PreviewBrowser"
                                Visibility="{Binding GeneratedHtml, Converter={StaticResource NullToCollapsedConverter}, FallbackValue=Collapsed}" />
                </Grid>
            </Border>

            <!-- Status bar -->
            <Border Grid.Row="1" Background="#F8F9FA" CornerRadius="4" Padding="8,6" Margin="0,6,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <ProgressBar Grid.Column="0"
                                 IsIndeterminate="{Binding IsBusy}"
                                 Width="80" Height="12"
                                 Margin="0,0,8,0"
                                 Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibleConverter}}" />

                    <TextBlock Grid.Column="1"
                               Text="{Binding StatusText}"
                               TextTrimming="CharacterEllipsis"
                               VerticalAlignment="Center"
                               FontSize="12"
                               ToolTip="{Binding StatusText}" />

                    <!-- Preview zoom -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
                        <Button Content="âˆ’" Padding="4,0" FontSize="12" FontWeight="Bold"
                                Command="{Binding ZoomOutCommand}"
                                ToolTip="Zoom out (âˆ’5%)" />
                        <TextBlock VerticalAlignment="Center" FontSize="11" Foreground="#6c757d" Margin="4,0"
                                   Text="{Binding PreviewZoom, StringFormat={}{0}%}"
                                   ToolTip="Preview zoom level â€” does not affect saved file or print" />
                        <Button Content="+" Padding="4,0" FontSize="12" FontWeight="Bold"
                                Command="{Binding ZoomInCommand}"
                                ToolTip="Zoom in (+5%)" />
                    </StackPanel>

                    <Button Grid.Column="3"
                            Content="Open in Browser"
                            Command="{Binding OpenInBrowserCommand}"
                            ToolTip="Open the generated calendar in the default browser"
                            Padding="8,4"
                            Margin="8,0,0,0"
                            Background="#28a745"
                            Foreground="White"
                            Visibility="{Binding GeneratedHtmlPath, Converter={StaticResource NullToCollapsedConverter}, FallbackValue=Collapsed}" />

                    <Button Grid.Column="4"
                            Content="View Source â†—"
                            Command="{Binding OpenSourceLinkCommand}"
                            ToolTip="Open the LINQ Connect public menu page in the default browser"
                            Padding="8,4"
                            Margin="4,0,0,0"
                            Background="#0d6efd"
                            Foreground="White"
                            Visibility="{Binding SourceUrl, Converter={StaticResource NullToCollapsedConverter}, FallbackValue=Collapsed}" />
                </Grid>
            </Border>
        </Grid>
    </Grid>
    </DockPanel>
</Window>
